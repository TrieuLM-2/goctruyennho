<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Chi ti·∫øt s√°ch">
    <title>Chi ti·∫øt s√°ch - M√™ ƒë·ªçc truy·ªán ch·ªØ</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/responsive.css">

    <link rel="icon" href="./assets/icons/favicon.ico">
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="container flex items-center justify-between">
            <a href="./index.html" class="logo">
                <span>üìö</span>
                <span>M√™ ƒë·ªçc truy·ªán ch·ªØ</span>
            </a>

            <nav class="nav-menu">
                <a href="./index.html" class="nav-link">Trang ch·ªß</a>
                <a href="./index.html?filter=completed" class="nav-link">Ho√†n th√†nh</a>
                <a href="./index.html?filter=ongoing" class="nav-link">ƒêang c·∫≠p nh·∫≠t</a>
            </nav>

            <div class="flex items-center gap-4">
                <div class="theme-toggle">
                    <button class="theme-btn active" data-theme-btn="light" title="S√°ng">‚òÄÔ∏è</button>
                    <button class="theme-btn" data-theme-btn="dark" title="T·ªëi">üåô</button>
                    <button class="theme-btn" data-theme-btn="sepia" title="Sepia">üìÑ</button>
                </div>
                <button class="mobile-menu-toggle mobile-only" id="mobileMenuToggle">‚ò∞</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-overlay">
                <div class="spinner"></div>
            </div>

            <!-- Book Detail Content -->
            <div id="bookDetail" class="hidden">
                <!-- Book Header -->
                <section class="book-detail-header flex gap-8 mb-8">
                    <div class="book-cover-large">
                        <img id="bookCover" src="" alt=""
                            style="width: 100%; max-width: 350px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-xl);">
                    </div>

                    <div class="flex-1">
                        <h1 id="bookTitle" class="text-4xl font-bold mb-3"></h1>
                        <p class="text-lg text-secondary mb-4">
                            T√°c gi·∫£: <span id="bookAuthor" class="font-semibold"></span>
                        </p>

                        <div class="genre-tags mb-4" id="bookGenres"></div>

                        <div class="rating-display mb-6">
                            <div class="rating-stars" id="bookRating"></div>
                            <span class="rating-value" id="avgRating">0.0</span>
                            <span class="rating-count" id="ratingCount">(0 ƒë√°nh gi√°)</span>
                            <span class="text-tertiary mx-3">‚Ä¢</span>
                            <span class="text-secondary" id="viewCount">0 l∆∞·ª£t ƒë·ªçc</span>
                        </div>

                        <div class="flex gap-3 mb-6">
                            <button class="btn btn-primary btn-lg" id="startReadingBtn">
                                üìñ B·∫Øt ƒë·∫ßu ƒë·ªçc
                            </button>
                            <button class="btn btn-secondary btn-lg" id="continueReadingBtn" style="display: none;">
                                ‚ñ∂Ô∏è ƒê·ªçc ti·∫øp
                            </button>
                            <button class="btn btn-ghost" onclick="addToShelf(URLUtils.getParam('id'))">
                                ‚≠ê Th√™m v√†o k·ªá
                            </button>
                        </div>

                        <div class="mb-4">
                            <span class="badge badge-primary" id="bookStatus"></span>
                            <span class="text-secondary ml-2" id="publishDate"></span>
                        </div>

                        <div id="readingProgress" class="mb-4" style="display: none;">
                            <div class="text-sm text-secondary mb-2">Ti·∫øn ƒë·ªô ƒë·ªçc c·ªßa b·∫°n:</div>
                            <div class="progress-bar" style="position: static; height: 8px;">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-tertiary mt-1" id="progressText"></div>
                        </div>
                    </div>
                </section>

                <!-- Synopsis -->
                <section class="mb-8">
                    <h2 class="text-2xl font-bold mb-4">üìù T√≥m t·∫Øt</h2>
                    <div class="bg-secondary rounded-lg p-6">
                        <p id="bookDescription" class="text-base line-height-relaxed"></p>
                    </div>
                </section>

                <!-- Chapter List and Comments Layout -->
                <div class="book-detail-layout">
                    <!-- Chapter List -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4">üìë M·ª•c l·ª•c (<span id="chapterCount">0</span> ch∆∞∆°ng)</h2>
                        <div class="chapter-list" id="chapterList">
                            <!-- Chapters will be loaded here -->
                        </div>
                    </section>

                    <!-- All Comments Section -->
                    <aside>
                        <div class="sidebar">
                            <h3 class="sidebar-title">üí¨ T·∫•t c·∫£ b√¨nh lu·∫≠n</h3>

                            <div class="mb-4">
                                <select id="commentSort" class="form-select">
                                    <option value="newest">M·ªõi nh·∫•t</option>
                                    <option value="likes">Nhi·ªÅu like nh·∫•t</option>
                                </select>
                            </div>

                            <div id="allComments">
                                <!-- Comments will be loaded here -->
                            </div>

                            <button class="btn btn-secondary w-full mt-4" id="loadMoreComments" style="width: 100%;">
                                Xem th√™m b√¨nh lu·∫≠n
                            </button>
                        </div>
                    </aside>
                </div>

                <!-- Related Books -->
                <section class="mt-12">
                    <h2 class="text-2xl font-bold mb-6">üìö S√°ch li√™n quan</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6" id="relatedBooks">
                        <!-- Related books will be loaded here -->
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2024 M√™ ƒë·ªçc truy·ªán ch·ªØ. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="./js/utils.js"></script>
    <script src="./js/theme.js"></script>
    <script src="./js/data-manager.js"></script>
    <script>
        // Book detail page logic
        let currentBook = null;
        let allComments = [];
        let displayedComments = 0;
        const commentsPerLoad = 10;

        document.addEventListener('DOMContentLoaded', async () => {
            const bookId = URLUtils.getParam('id');
            if (!bookId) {
                window.location.href = './index.html';
                return;
            }

            await loadBookDetail(bookId);
        });

        async function loadBookDetail(bookId) {
            try {
                currentBook = await dataManager.getBookById(bookId);
                if (!currentBook) {
                    showError('Kh√¥ng t√¨m th·∫•y truy·ªán');
                    return;
                }

                // Update page title
                document.title = `${currentBook.title} - M√™ ƒë·ªçc truy·ªán ch·ªØ`;

                // Display book info
                document.getElementById('bookCover').src = currentBook.cover;
                document.getElementById('bookCover').alt = currentBook.title;
                document.getElementById('bookTitle').textContent = currentBook.title;
                document.getElementById('bookAuthor').textContent = currentBook.author;
                document.getElementById('bookDescription').textContent = currentBook.description;

                // Genres
                document.getElementById('bookGenres').innerHTML = currentBook.genres
                    .map(g => `<span class="genre-tag">${g}</span>`).join('');

                // Rating
                const rating = currentBook.avgRating || 0;
                const stars = '‚≠ê'.repeat(Math.floor(rating));
                document.getElementById('bookRating').innerHTML = stars;
                document.getElementById('avgRating').textContent = rating.toFixed(1);
                document.getElementById('ratingCount').textContent = `(${currentBook.totalRatings || 0} ƒë√°nh gi√°)`;
                document.getElementById('viewCount').textContent = `${formatNumber(currentBook.views || 0)} l∆∞·ª£t ƒë·ªçc`;

                // Status
                const statusEl = document.getElementById('bookStatus');
                if (currentBook.status === 'completed') {
                    statusEl.textContent = 'Ho√†n th√†nh';
                    statusEl.className = 'badge badge-success';
                } else {
                    statusEl.textContent = 'ƒêang c·∫≠p nh·∫≠t';
                    statusEl.className = 'badge badge-warning';
                }

                // Publish date
                if (currentBook.dateAdded) {
                    document.getElementById('publishDate').textContent =
                        `ƒêƒÉng ng√†y ${DateUtils.formatSimple(currentBook.dateAdded)}`;
                }

                // Load chapters
                await loadChapters(bookId);

                // Load comments
                await loadComments(bookId);

                // Load related books
                await loadRelatedBooks();

                // Check reading progress
                checkReadingProgress(bookId);

                // Show content
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('bookDetail').classList.remove('hidden');
                document.getElementById('bookDetail').classList.add('animate-fade-in');

            } catch (error) {
                console.error('Error loading book:', error);
                showError('L·ªói khi t·∫£i th√¥ng tin truy·ªán');
            }
        }

        async function loadChapters(bookId) {
            const chapters = await dataManager.getBookChapters(bookId);
            document.getElementById('chapterCount').textContent = chapters.length;

            const chapterList = document.getElementById('chapterList');
            chapterList.innerHTML = chapters.map((chapter, index) => {
                const isRead = ReadingProgress.isChapterRead(bookId, chapter.id);
                return `
          <div class="chapter-item ${isRead ? 'read' : ''}" onclick="goToChapter('${chapter.id}')">
            <div class="chapter-number">Ch∆∞∆°ng ${chapter.chapterNum}</div>
            <div class="chapter-title">${chapter.title}</div>
            <div class="chapter-date">${DateUtils.formatSimple(chapter.uploadDate)}</div>
            <div class="chapter-status ${isRead ? '' : 'unread'}"></div>
          </div>
        `;
            }).join('');

            // Setup start reading button
            if (chapters.length > 0) {
                document.getElementById('startReadingBtn').onclick = () => {
                    goToChapter(chapters[0].id);
                };
            }
        }

        async function loadComments(bookId) {
            allComments = await dataManager.getBookComments(bookId);
            displayedComments = 0;
            displayComments();
        }

        function displayComments() {
            const container = document.getElementById('allComments');
            const end = Math.min(displayedComments + commentsPerLoad, allComments.length);
            const commentsToShow = allComments.slice(displayedComments, end);

            const html = commentsToShow.map(comment => createCommentHTML(comment)).join('');

            if (displayedComments === 0) {
                container.innerHTML = html;
            } else {
                container.innerHTML += html;
            }

            displayedComments = end;

            // Update load more button
            const loadMoreBtn = document.getElementById('loadMoreComments');
            if (displayedComments >= allComments.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = displayComments;
            }

            if (allComments.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center p-6">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</p>';
            }
        }

        function createCommentHTML(comment) {
            return `
        <div class="comment-card">
          <div class="comment-header">
            <img src="${comment.userAvatar || './assets/avatars/default.jpg'}" alt="" class="comment-avatar">
            <div class="comment-user-info">
              <div class="comment-username">${comment.username || 'Anonymous'}</div>
              <div class="comment-meta">
                Ch∆∞∆°ng ${comment.chapterNumber} ‚Ä¢ ${DateUtils.getRelativeTime(comment.timestamp)}
              </div>
            </div>
          </div>
          <div class="comment-text">${comment.text}</div>
          <div class="comment-actions">
            <span class="comment-action">
              üëç ${comment.likes || 0}
            </span>
          </div>
        </div>
      `;
        }

        async function loadRelatedBooks() {
            const allBooks = await dataManager.getBooks();
            const related = allBooks
                .filter(b => b.id !== currentBook.id &&
                    b.genres.some(g => currentBook.genres.includes(g)))
                .slice(0, 5);

            const container = document.getElementById('relatedBooks');
            container.innerHTML = related.map(book => `
        <div class="book-card" onclick="window.location.href='./book.html?id=${book.id}'">
          <div class="book-card-cover">
            <img src="${book.cover}" alt="${book.title}" loading="lazy">
          </div>
          <div class="book-card-content">
            <h4 class="book-card-title line-clamp-2">${book.title}</h4>
            <p class="book-card-author">${book.author}</p>
          </div>
        </div>
      `).join('');
        }

        function checkReadingProgress(bookId) {
            const progress = ReadingProgress.getPosition(bookId);
            if (progress && progress.chapterId) {
                const continueBtn = document.getElementById('continueReadingBtn');
                continueBtn.style.display = 'inline-flex';
                continueBtn.onclick = () => goToChapter(progress.chapterId);

                // Show progress bar
                const readChapters = ReadingProgress.getReadChapters(bookId);
                const totalChapters = currentBook.chapters.length;
                const progressPercent = Math.round((readChapters.length / totalChapters) * 100);

                document.getElementById('readingProgress').style.display = 'block';
                document.getElementById('progressFill').style.width = `${progressPercent}%`;
                document.getElementById('progressText').textContent =
                    `ƒê√£ ƒë·ªçc ${readChapters.length}/${totalChapters} ch∆∞∆°ng (${progressPercent}%)`;
            }
        }

        function goToChapter(chapterId) {
            window.location.href = `./read.html?id=${chapterId}`;
        }

        function addToShelf(bookId) {
            const shelf = LocalStorage.get('myShelf', []);
            if (!shelf.includes(bookId)) {
                shelf.push(bookId);
                LocalStorage.set('myShelf', shelf);
                showToast('ƒê√£ th√™m v√†o k·ªá s√°ch!', 'success');
            } else {
                showToast('Truy·ªán ƒë√£ c√≥ trong k·ªá s√°ch!', 'info');
            }
        }

        function showError(message) {
            document.getElementById('loadingState').innerHTML = `
        <div style="text-align: center; padding: var(--space-16);">
          <p class="text-2xl mb-4">‚ùå</p>
          <p class="text-lg text-secondary mb-6">${message}</p>
          <button class="btn btn-primary" onclick="window.location.href='./index.html'">
            V·ªÅ trang ch·ªß
          </button>
        </div>
      `;
        }
    </script>
</body>

</html>